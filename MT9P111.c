/***********************************************************************
 *                                                                     
 * Project: Balthazar
 * $Date: 2013/10/04 $
 * $Author: pfitger $
 *
 * $Id: //depot/Balthazar/Camera/OS/Experimental/linux/drivers/vcam/MT9P111.c#1 $
 *
 * Description of file:
 *   Visual Camera Driver
 *
 * Last check-in changelist:
 * $Change: 179282 $
 *
 * Copyright: FLIR Systems AB
 ***********************************************************************/

#include "flir_kernel_os.h"
#include "vcam_internal.h"
#include "i2cdev.h"
#include <linux/i2c.h>

// Local typedefs

typedef enum {CAM_1, CAM_2, CAM_ALL} CAM_NO;

// Local definitions

#define DEBUG_TMO           0
#define PICO_ARTNO 197639
#define GICO_ARTNO 197260

// Local functions

// Local variables
static BOOL bCamActive[CAM_ALL] = { TRUE, FALSE };

/* dataformat to send to camera over i2c, 16 bits register and 16 bits of data
  nr of bytes to send, register high byte, register low byte, data high byte, data low byte*/
static const UCHAR I2CDataInitPart1[][5] =
{
  { 4, 0x00, 0x10, 0x09, 0x3F },
  { 4, 0x00, 0x12, 0x00, 0x70 },
  { 4, 0x00, 0x14, 0x20, 0x25 },
  { 4, 0x00, 0x1E, 0x04, 0x44 },	//Pad Slew Pad Config: 4(clk) 4(gpio) 4(dout,fv,lv) [JALE]
  { 4, 0x00, 0x22, 0x03, 0x20 },
  { 4, 0x00, 0x2A, 0x7F, 0x58 },
  { 4, 0x00, 0x2C, 0x00, 0x00 },
  { 4, 0x00, 0x2E, 0x00, 0x00 },
  { 4, 0x00, 0x18, 0x40, 0x08 },
};
// PLL Settings
static const UCHAR I2CDataInitPart1GF[][5] =
{
  { 4, 0x00, 0x10, 0x03, 0x14 },	//PLL Dividers = 788
  { 4, 0x00, 0x12, 0x00, 0xF0 },	//PLL P Dividers = 240
  { 4, 0x00, 0x14, 0x20, 0x25 },	//PLL Control: TEST_BYPASS off = 8229
  { 4, 0x00, 0x1E, 0x04, 0x41 },	//Pad Slew Pad Config: 4(clk) 4(gpio) 1(dout,fv,lv)
  { 4, 0x00, 0x22, 0x03, 0x20 },	//VDD_DIS counter delay
  { 4, 0x00, 0x2A, 0x7C, 0x46 },	//PLL P Dividers 4-5-6 = 31814
  { 4, 0x00, 0x2C, 0x00, 0x00 },	//PLL P Dividers 7 = 0
  { 4, 0x00, 0x2E, 0x00, 0x00 },	//Sensor Clock Divider = 0
  { 4, 0x00, 0x18, 0x40, 0x08 },	//Standby Control and Status: Out of standby
};

static const UCHAR I2CDataInitPart2[][5] =
{
  { 4, 0x30, 0xD4, 0x90, 0x80 },         //Disable Double Samplings
  { 4, 0x00, 0x18, 0x20, 0x09 },		//Standby Control and Status: Enter standby
};

static const UCHAR I2CDataInitPart3[][5] =
{
  { 4, 0x00, 0x18, 0x40, 0x08 },
  { 4, 0x09, 0x8E, 0x48, 0x6C },
  { 4, 0x09, 0x90, 0x05, 0x18 },
  { 4, 0x09, 0x8E, 0x48, 0x6E },
  { 4, 0x09, 0x90, 0x03, 0xD4 },
  { 4, 0x09, 0x8E, 0x48, 0x3A },
  { 4, 0x09, 0x90, 0x00, 0x0C },
  { 4, 0x09, 0x8E, 0x48, 0x3C },
  { 4, 0x09, 0x90, 0x00, 0x18 },
  { 4, 0x09, 0x8E, 0x48, 0x3E },
  { 4, 0x09, 0x90, 0x07, 0xB1 },
  { 4, 0x09, 0x8E, 0x48, 0x40 },
  { 4, 0x09, 0x90, 0x0A, 0x45 },
  { 4, 0x09, 0x8E, 0x48, 0x42 },
  { 4, 0x09, 0x90, 0x00, 0x01 },
  { 4, 0x09, 0x8E, 0x48, 0x44 },
  { 4, 0x09, 0x90, 0x01, 0x03 },
  { 4, 0x09, 0x8E, 0x48, 0x46 },
  { 4, 0x09, 0x90, 0x01, 0x03 },
  { 4, 0x09, 0x8E, 0x48, 0x48 },
  { 4, 0x09, 0x90, 0x01, 0x03 },
  { 4, 0x09, 0x8E, 0x48, 0x4A },
  { 4, 0x09, 0x90, 0x01, 0x03 },
  { 4, 0x09, 0x8E, 0x48, 0x4C },
  { 4, 0x09, 0x90, 0x00, 0xF6 },
  { 4, 0x09, 0x8E, 0x48, 0x4E },
  { 4, 0x09, 0x90, 0x00, 0x01 },
  { 4, 0x09, 0x8E, 0xC8, 0x51 },
  { 3, 0x09, 0x90, 0x00 },
  { 4, 0x09, 0x8E, 0xC8, 0x50 },	// Orientation (A)
  { 3, 0x09, 0x90, 0x03 },		    // = 3 (Mirror and flip) [JALE]
  { 4, 0x09, 0x8E, 0x48, 0x52 },
  { 4, 0x09, 0x90, 0x01, 0x9C },
  { 4, 0x09, 0x8E, 0x48, 0x54 },
  { 4, 0x09, 0x90, 0x07, 0x32 },
  { 4, 0x09, 0x8E, 0x48, 0x56 },
  { 4, 0x09, 0x90, 0x04, 0x8E },
  { 4, 0x09, 0x8E, 0x48, 0x58 },
  { 4, 0x09, 0x90, 0x00, 0x02 },
  { 4, 0x09, 0x8E, 0x48, 0x5A },
  { 4, 0x09, 0x90, 0x00, 0x01 },
  { 4, 0x09, 0x8E, 0x48, 0x5C },
  { 4, 0x09, 0x90, 0x04, 0x29 },
  { 4, 0x09, 0x8E, 0x48, 0x5E },
  { 4, 0x09, 0x90, 0xFF, 0xFF },
  { 4, 0x09, 0x8E, 0x48, 0x60 },
  { 4, 0x09, 0x90, 0x04, 0x29 },
  { 4, 0x09, 0x8E, 0x48, 0x62 },
  { 4, 0x09, 0x90, 0x0D, 0xB0 },
  { 4, 0x09, 0x8E, 0x48, 0x64 },
  { 4, 0x09, 0x90, 0xFF, 0xFE },
  { 4, 0x09, 0x8E, 0x48, 0x66 },
  { 4, 0x09, 0x90, 0x7F, 0x58 },
  { 4, 0x09, 0x8E, 0x48, 0x68 },
  { 4, 0x09, 0x90, 0x04, 0x29 },
  { 4, 0x09, 0x8E, 0x48, 0x6A },
  { 4, 0x09, 0x90, 0x0D, 0xB0 },
  { 4, 0x09, 0x8E, 0x48, 0x70 },
  { 4, 0x09, 0x90, 0x00, 0x14 },
  { 4, 0x09, 0x8E, 0x48, 0xAA },
  { 4, 0x09, 0x90, 0x04, 0x00 },
  { 4, 0x09, 0x8E, 0x48, 0xAC },
  { 4, 0x09, 0x90, 0x03, 0x00 },
  { 4, 0x09, 0x8E, 0x48, 0xAE },
  { 4, 0x09, 0x90, 0x00, 0x01 },
  { 4, 0x09, 0x8E, 0x48, 0xB0 },
  { 4, 0x09, 0x90, 0x00, 0x00 },
  { 4, 0x09, 0x8E, 0x48, 0xB8 },
  { 4, 0x09, 0x90, 0x00, 0x04 },
  { 4, 0x09, 0x8E, 0x48, 0xA4 },
  { 4, 0x09, 0x90, 0x0A, 0x28 },
  { 4, 0x09, 0x8E, 0x48, 0xA6 },
  { 4, 0x09, 0x90, 0x07, 0xA0 },
  { 4, 0x09, 0x8E, 0x48, 0x72 },
  { 4, 0x09, 0x90, 0x00, 0x10 },
  { 4, 0x09, 0x8E, 0x48, 0x74 },
  { 4, 0x09, 0x90, 0x00, 0x1C },
  { 4, 0x09, 0x8E, 0x48, 0x76 },
  { 4, 0x09, 0x90, 0x07, 0xAF },
  { 4, 0x09, 0x8E, 0x48, 0x78 },
  { 4, 0x09, 0x90, 0x0A, 0x43 },
  { 4, 0x09, 0x8E, 0x48, 0x7A },
  { 4, 0x09, 0x90, 0x00, 0x01 },
  { 4, 0x09, 0x8E, 0x48, 0x7C },
  { 4, 0x09, 0x90, 0x01, 0x01 },
  { 4, 0x09, 0x8E, 0x48, 0x7E },
  { 4, 0x09, 0x90, 0x01, 0x01 },
  { 4, 0x09, 0x8E, 0x48, 0x80 },
  { 4, 0x09, 0x90, 0x01, 0x01 },
  { 4, 0x09, 0x8E, 0x48, 0x82 },
  { 4, 0x09, 0x90, 0x01, 0x01 },
  { 4, 0x09, 0x8E, 0x48, 0x84 },
  { 4, 0x09, 0x90, 0x00, 0xF2 },
  { 4, 0x09, 0x8E, 0x48, 0x86 },
  { 4, 0x09, 0x90, 0x00, 0x00 },
  { 4, 0x09, 0x8E, 0xC8, 0x89 },
  { 3, 0x09, 0x90, 0x00 },
  { 4, 0x09, 0x8E, 0xC8, 0x88 },	// Orientation (B)
  { 3, 0x09, 0x90, 0x03 },		    // = 3 (Mirror and flip) [JALE]
  { 4, 0x09, 0x8E, 0x48, 0x8A },
  { 4, 0x09, 0x90, 0x00, 0x9C },
  { 4, 0x09, 0x8E, 0x48, 0x8C },
  { 4, 0x09, 0x90, 0x03, 0x4A },
  { 4, 0x09, 0x8E, 0x48, 0x8E },
  { 4, 0x09, 0x90, 0x02, 0xA6 },
  { 4, 0x09, 0x8E, 0x48, 0x90 },
  { 4, 0x09, 0x90, 0x00, 0x02 },
  { 4, 0x09, 0x8E, 0x48, 0x92 },
  { 4, 0x09, 0x90, 0x00, 0x01 },
  { 4, 0x09, 0x8E, 0x48, 0x94 },
  { 4, 0x09, 0x90, 0x07, 0xFD },
  { 4, 0x09, 0x8E, 0x48, 0x96 },
  { 4, 0x09, 0x90, 0xFF, 0xFF },
  { 4, 0x09, 0x8E, 0x48, 0x98 },
  { 4, 0x09, 0x90, 0x07, 0xFD },
  { 4, 0x09, 0x8E, 0x48, 0x9A },
  { 4, 0x09, 0x90, 0x0F, 0x24 },
  { 4, 0x09, 0x8E, 0x48, 0x9C },
  { 4, 0x09, 0x90, 0xFF, 0xFE },
  { 4, 0x09, 0x8E, 0x48, 0x9E },
  { 4, 0x09, 0x90, 0x7F, 0x58 },
  { 4, 0x09, 0x8E, 0x48, 0xA0 },
  { 4, 0x09, 0x90, 0x07, 0xFD },
  { 4, 0x09, 0x8E, 0x48, 0xA2 },
  { 4, 0x09, 0x90, 0x0F, 0x24 },
  { 4, 0x09, 0x8E, 0x48, 0xA8 },
  { 4, 0x09, 0x90, 0x00, 0x14 },
  { 4, 0x09, 0x8E, 0x48, 0xC0 },
  { 4, 0x09, 0x90, 0x0A, 0x20 },
  { 4, 0x09, 0x8E, 0x48, 0xC2 },
  { 4, 0x09, 0x90, 0x07, 0x98 },
  { 4, 0x09, 0x8E, 0x48, 0xC4 },
  { 4, 0x09, 0x90, 0x00, 0x01 },
  { 4, 0x09, 0x8E, 0x48, 0xC6 },
  { 4, 0x09, 0x90, 0x00, 0x00 },
  { 4, 0x09, 0x8E, 0x48, 0xCE },
  { 4, 0x09, 0x90, 0x00, 0x07 }, //0x05
  { 4, 0x09, 0x8E, 0x20, 0x10 },
  { 4, 0x09, 0x90, 0x01, 0x36 },
  { 4, 0x09, 0x8E, 0x20, 0x12 },
  { 4, 0x09, 0x90, 0x01, 0x4A },
  { 4, 0x09, 0x8E, 0x20, 0x14 },
  { 4, 0x09, 0x90, 0x01, 0x00 },
  { 4, 0x09, 0x8E, 0x20, 0x16 },
  { 4, 0x09, 0x90, 0x01, 0x14 },
  { 4, 0x09, 0x8E, 0x20, 0x18 },
  { 4, 0x09, 0x90, 0x01, 0x40 },
  { 4, 0x09, 0x8E, 0x20, 0x1A },
  { 4, 0x09, 0x90, 0x01, 0x21 },
  { 4, 0x09, 0x8E, 0x20, 0x1C },
  { 4, 0x09, 0x90, 0x01, 0x0A },
  { 4, 0x09, 0x8E, 0x20, 0x1E },
  { 4, 0x09, 0x90, 0x00, 0xF1 },
  { 4, 0x09, 0x8E, 0xDC, 0x0A },
  { 4, 0x09, 0x90, 0x00, 0x06 },
  { 4, 0x09, 0x8E, 0x5C, 0x1C },
  { 4, 0x09, 0x90, 0x27, 0x10 },
  { 4, 0x09, 0x8E, 0x60, 0x04 },
  { 4, 0x09, 0x90, 0x13, 0xB0 },
  { 4, 0x09, 0x8E, 0x84, 0x04 },	// Refresh Sequencer Mode
  { 3, 0x09, 0x90, 0x06 },		//      = 6
};
// Timing settings
static const UCHAR I2CDataInitPart3GF[][5] =
{
  { 4, 0x00, 0x18, 0x40, 0x08 },	//Standby Control and Status: Out off standby
  { 4, 0x09, 0x8E, 0x48, 0x6C },	//Output Width (A)
  { 4, 0x09, 0x90, 0x05, 0x18 },	//      = 1304
  { 4, 0x09, 0x8E, 0x48, 0x6E },	//Output Height (A)
  { 4, 0x09, 0x90, 0x03, 0xD4 },	//      = 980
  { 4, 0x09, 0x8E, 0x48, 0x3A },	//Row Start (A)
  { 4, 0x09, 0x90, 0x00, 0x0C },	//      = 12
  { 4, 0x09, 0x8E, 0x48, 0x3C },	//Column Start (A)
  { 4, 0x09, 0x90, 0x00, 0x18 },	//      = 24
  { 4, 0x09, 0x8E, 0x48, 0x3E },	//Row End (A)
  { 4, 0x09, 0x90, 0x07, 0xB1 },	//      = 1969
  { 4, 0x09, 0x8E, 0x48, 0x40 },	//Column End (A)
  { 4, 0x09, 0x90, 0x0A, 0x45 },	//      = 2629
  { 4, 0x09, 0x8E, 0x48, 0x42 },	//Row Speed (A)
  { 4, 0x09, 0x90, 0x00, 0x01 },	//      = 1
  { 4, 0x09, 0x8E, 0x48, 0x44 },	//Core Skip X (A)
  { 4, 0x09, 0x90, 0x01, 0x03 },	//      = 259
  { 4, 0x09, 0x8E, 0x48, 0x46 },	//Core Skip Y (A)
  { 4, 0x09, 0x90, 0x01, 0x03 },	//      = 259
  { 4, 0x09, 0x8E, 0x48, 0x48 },	//Pipe Skip X (A)
  { 4, 0x09, 0x90, 0x01, 0x03 },	//      = 259
  { 4, 0x09, 0x8E, 0x48, 0x4A },	//Pipe Skip Y (A)
  { 4, 0x09, 0x90, 0x01, 0x03 },	//      = 259
  { 4, 0x09, 0x8E, 0x48, 0x4C },	//Power Mode (A)
  { 4, 0x09, 0x90, 0x00, 0xF6 },	//      = 246
  { 4, 0x09, 0x8E, 0x48, 0x4E },	//Bin Mode (A)
  { 4, 0x09, 0x90, 0x00, 0x01 },	//      = 1
  { 4, 0x09, 0x8E, 0xC8, 0x51 },	//Pixel Order (A)
  { 3, 0x09, 0x90, 0x00 },		//      = 0
  { 4, 0x09, 0x8E, 0xC8, 0x50 },	//Orientation (A)
  { 3, 0x09, 0x90, 0x03 },		    // = 0 -> 3 (Mirror and flip - also for GF) [ULPA]
  { 4, 0x09, 0x8E, 0x48, 0x52 },	//Fine Correction (A)
  { 4, 0x09, 0x90, 0x01, 0x9C },	//      = 412
  { 4, 0x09, 0x8E, 0x48, 0x54 },	//Fine IT Min (A)
  { 4, 0x09, 0x90, 0x07, 0x32 },	//      = 1842
  { 4, 0x09, 0x8E, 0x48, 0x56 },	//Fine IT Max Margin (A)
  { 4, 0x09, 0x90, 0x04, 0x8E },	//      = 1166
  { 4, 0x09, 0x8E, 0x48, 0x58 },	//Coarse IT Min (A)
  { 4, 0x09, 0x90, 0x00, 0x02 },	//      = 2
  { 4, 0x09, 0x8E, 0x48, 0x5A },	//Coarse IT Max Margin (A)
  { 4, 0x09, 0x90, 0x00, 0x01 },	//      = 1
  { 4, 0x09, 0x8E, 0x48, 0x5C },	//Min Frame Lines (A)
  { 4, 0x09, 0x90, 0x04, 0x23 },	//      = 1059
  { 4, 0x09, 0x8E, 0x48, 0x5E },	//Max Frame Lines (A)
  { 4, 0x09, 0x90, 0xFF, 0xFF },	//      = 65535
  { 4, 0x09, 0x8E, 0x48, 0x60 },	//Base Frame Lines (A)
  { 4, 0x09, 0x90, 0x04, 0x23 },	//      = 1059
  { 4, 0x09, 0x8E, 0x48, 0x62 },	//Min Line Length (A)
  { 4, 0x09, 0x90, 0x0E, 0x0D },	//      = 3597
  { 4, 0x09, 0x8E, 0x48, 0x64 },	//Max Line Length (A)
  { 4, 0x09, 0x90, 0xFF, 0xFE },	//      = 65534
  { 4, 0x09, 0x8E, 0x48, 0x66 },	//P456 Divider (A)
  { 4, 0x09, 0x90, 0x7C, 0x46 },	//      = 31814
  { 4, 0x09, 0x8E, 0x48, 0x68 },	//Frame Lines (A)
  { 4, 0x09, 0x90, 0x04, 0x23 },	//      = 1059
  { 4, 0x09, 0x8E, 0x48, 0x6A },	//Line Length (A)
  { 4, 0x09, 0x90, 0x0E, 0x0D },	//      = 3597
  { 4, 0x09, 0x8E, 0x48, 0x70 },	//RX FIFO Watermark (A)
  { 4, 0x09, 0x90, 0x00, 0x14 },	//      = 20
  { 4, 0x09, 0x8E, 0x48, 0xAA },	//Output_0 Image Width
  { 4, 0x09, 0x90, 0x02, 0x80 },	//      = 640
  { 4, 0x09, 0x8E, 0x48, 0xAC },	//Output_0 Image Height
  { 4, 0x09, 0x90, 0x01, 0xE0 },	//      = 480
  { 4, 0x09, 0x8E, 0x48, 0xAE },	//Output_0 Image Format
  { 4, 0x09, 0x90, 0x00, 0x01 },	//      = 1
  { 4, 0x09, 0x8E, 0x48, 0xB0 },	//Output_0 Format Order
  { 4, 0x09, 0x90, 0x00, 0x00 },	//      = 0
  { 4, 0x09, 0x8E, 0x48, 0xB8 },	//Output_0 JPEG control
  { 4, 0x09, 0x90, 0x00, 0x04 },	//      = 4
  { 4, 0x09, 0x8E, 0x48, 0xA4 },	//Output Width (B)
  { 4, 0x09, 0x90, 0x0A, 0x28 },	//      = 2600
  { 4, 0x09, 0x8E, 0x48, 0xA6 },	//Output Height (B)
  { 4, 0x09, 0x90, 0x07, 0xA0 },	//      = 1952
  { 4, 0x09, 0x8E, 0x48, 0x72 },	//Row Start (B)
  { 4, 0x09, 0x90, 0x00, 0x10 },	//      = 16
  { 4, 0x09, 0x8E, 0x48, 0x74 },	//Column Start (B)
  { 4, 0x09, 0x90, 0x00, 0x1C },	//      = 28
  { 4, 0x09, 0x8E, 0x48, 0x76 },	//Row End (B)
  { 4, 0x09, 0x90, 0x07, 0xAF },	//      = 1967
  { 4, 0x09, 0x8E, 0x48, 0x78 },	//Column End (B)
  { 4, 0x09, 0x90, 0x0A, 0x43 },	//      = 2627
  { 4, 0x09, 0x8E, 0x48, 0x7A },	//Row Speed (B)
  { 4, 0x09, 0x90, 0x00, 0x01 },	//      = 1
  { 4, 0x09, 0x8E, 0x48, 0x7C },	//Core Skip X (B)
  { 4, 0x09, 0x90, 0x01, 0x01 },	//      = 257
  { 4, 0x09, 0x8E, 0x48, 0x7E },	//Core Skip Y (B)
  { 4, 0x09, 0x90, 0x01, 0x01 },	//      = 257
  { 4, 0x09, 0x8E, 0x48, 0x80 },	//Pipe Skip X (B)
  { 4, 0x09, 0x90, 0x01, 0x01 },	//      = 257
  { 4, 0x09, 0x8E, 0x48, 0x82 },	//Pipe Skip Y (B)
  { 4, 0x09, 0x90, 0x01, 0x01 },	//      = 257
  { 4, 0x09, 0x8E, 0x48, 0x84 },	//Power Mode (B)
  { 4, 0x09, 0x90, 0x00, 0xF2 },	//      = 242
  { 4, 0x09, 0x8E, 0x48, 0x86 },	//Bin Mode (B)
  { 4, 0x09, 0x90, 0x00, 0x00 },	//      = 0
  { 4, 0x09, 0x8E, 0xC8, 0x89 },	//Pixel Order (B)
  { 3, 0x09, 0x90, 0x00 },		//      = 0
  { 4, 0x09, 0x8E, 0xC8, 0x88 },	//Orientation (B)
  { 3, 0x09, 0x90, 0x03 },		    // = 0 -> 3 (Mirror and flip - also for GF) [ULPA]
  { 4, 0x09, 0x8E, 0x48, 0x8A },	//Fine Correction (B)
  { 4, 0x09, 0x90, 0x00, 0x9C },	//      = 156
  { 4, 0x09, 0x8E, 0x48, 0x8C },	//Fine IT Min (B)
  { 4, 0x09, 0x90, 0x03, 0x4A },	//      = 842
  { 4, 0x09, 0x8E, 0x48, 0x8E },	//Fine IT Max Margin (B)
  { 4, 0x09, 0x90, 0x02, 0xA6 },	//      = 678
  { 4, 0x09, 0x8E, 0x48, 0x90 },	//Coarse IT Min (B)
  { 4, 0x09, 0x90, 0x00, 0x02 },	//      = 2
  { 4, 0x09, 0x8E, 0x48, 0x92 },	//Coarse IT Max Margin (B)
  { 4, 0x09, 0x90, 0x00, 0x01 },	//      = 1
  { 4, 0x09, 0x8E, 0x48, 0x94 },	//Min Frame Lines (B)
  { 4, 0x09, 0x90, 0x07, 0xEF },	//      = 2031
  { 4, 0x09, 0x8E, 0x48, 0x96 },	//Max Frame Lines (B)
  { 4, 0x09, 0x90, 0xFF, 0xFF },	//      = 65535
  { 4, 0x09, 0x8E, 0x48, 0x98 },	//Base Frame Lines (B)
  { 4, 0x09, 0x90, 0x07, 0xEF },	//      = 2031
  { 4, 0x09, 0x8E, 0x48, 0x9A },	//Min Line Length (B)
  { 4, 0x09, 0x90, 0x0F, 0x8F },	//      = 3983
  { 4, 0x09, 0x8E, 0x48, 0x9C },	//Max Line Length (B)
  { 4, 0x09, 0x90, 0xFF, 0xFE },	//      = 65534
  { 4, 0x09, 0x8E, 0x48, 0x9E },	//P456 Divider (B)
  { 4, 0x09, 0x90, 0x7C, 0x46 },	//      = 31814
  { 4, 0x09, 0x8E, 0x48, 0xA0 },	//Frame Lines (B)
  { 4, 0x09, 0x90, 0x07, 0xEF },	//      = 2031
  { 4, 0x09, 0x8E, 0x48, 0xA2 },	//Line Length (B)
  { 4, 0x09, 0x90, 0x0F, 0x8F },	//      = 3983
  { 4, 0x09, 0x8E, 0x48, 0xA8 },	//RX FIFO Watermark (B)
  { 4, 0x09, 0x90, 0x00, 0x14 },	//      = 20
  { 4, 0x09, 0x8E, 0x48, 0xC0 },	//Output_1 Image Width
  { 4, 0x09, 0x90, 0x08, 0x00 },	//      = 2048
  { 4, 0x09, 0x8E, 0x48, 0xC2 },	//Output_1 Image Height
  { 4, 0x09, 0x90, 0x06, 0x00 },	//      = 1536
  { 4, 0x09, 0x8E, 0x48, 0xC4 },	//Output_1 Image Format
  { 4, 0x09, 0x90, 0x00, 0x01 },	//      = 1
  { 4, 0x09, 0x8E, 0x48, 0xC6 },	//Output_1 Format Order
  { 4, 0x09, 0x90, 0x00, 0x00 },	//      = 0
  { 4, 0x09, 0x8E, 0x48, 0xCE },	//Output_1 JPEG control
  { 4, 0x09, 0x90, 0x00, 0x07 },	//      = 7
  { 4, 0x09, 0x8E, 0x20, 0x10 },	//fd_min_expected50hz_flicker_period
  { 4, 0x09, 0x90, 0x01, 0x34 },	//      = 308
  { 4, 0x09, 0x8E, 0x20, 0x12 },	//fd_max_expected50hz_flicker_period
  { 4, 0x09, 0x90, 0x01, 0x48 },	//      = 328
  { 4, 0x09, 0x8E, 0x20, 0x14 },	//fd_min_expected60hz_flicker_period
  { 4, 0x09, 0x90, 0x00, 0xFF },	//      = 255
  { 4, 0x09, 0x8E, 0x20, 0x16 },	//fd_max_expected60hz_flicker_period
  { 4, 0x09, 0x90, 0x01, 0x13 },	//      = 275
  { 4, 0x09, 0x8E, 0x20, 0x18 },	//fd_expected50hz_flicker_period (A)
  { 4, 0x09, 0x90, 0x01, 0x3E },	//      = 318
  { 4, 0x09, 0x8E, 0x20, 0x1A },	//fd_expected50hz_flicker_period (B)
  { 4, 0x09, 0x90, 0x01, 0x1F },	//      = 287
  { 4, 0x09, 0x8E, 0x20, 0x1C },	//fd_expected60hz_flicker_period (A)
  { 4, 0x09, 0x90, 0x01, 0x09 },	//      = 265
  { 4, 0x09, 0x8E, 0x20, 0x1E },	//fd_expected60hz_flicker_period (B)
  { 4, 0x09, 0x90, 0x00, 0xEF },	//      = 239
  { 4, 0x09, 0x8E, 0xDC, 0x0A },	//Scaler Allow Zoom Ratio
  { 3, 0x09, 0x90, 0x06 },		//      = 6
  { 4, 0x09, 0x8E, 0x5C, 0x1C },	//System Zoom Ratio
  { 4, 0x09, 0x90, 0x27, 0x10 },	//      = 10000
  { 4, 0x09, 0x8E, 0x60, 0x04 },	//I2C Master Clock Divider
  { 4, 0x09, 0x90, 0x0F, 0xA0 },	//      = 4000
  { 4, 0x09, 0x8E, 0x84, 0x04 },	//Refresh Sequencer Mode
  { 3, 0x09, 0x90, 0x06 },		//      = 6
};

// Step 3.1, load patch from beta 4 release, k28a_rev03_patch01_basic_REV5
static const UCHAR I2CDataInitPart4[][5] =
{
  { 4, 0x09, 0x82, 0x00, 0x00 },
  { 4, 0x09, 0x8A, 0x00, 0x00 },
  { 4, 0x88, 0x6C, 0xC0, 0xF1 },
  { 4, 0x88, 0x6E, 0xC5, 0xE1 },
  { 4, 0x88, 0x70, 0x24, 0x6A },
  { 4, 0x88, 0x72, 0x12, 0x80 },
  { 4, 0x88, 0x74, 0xC4, 0xE1 },
  { 4, 0x88, 0x76, 0xD2, 0x0F },
  { 4, 0x88, 0x78, 0x20, 0x69 },
  { 4, 0x88, 0x7A, 0x00, 0x00 },
  { 4, 0x88, 0x7C, 0x6A, 0x62 },
  { 4, 0x88, 0x7E, 0x13, 0x03 },
  { 4, 0x88, 0x80, 0x00, 0x84 },
  { 4, 0x88, 0x82, 0x17, 0x34 },
  { 4, 0x88, 0x84, 0x70, 0x05 },
  { 4, 0x88, 0x86, 0xD8, 0x01 },
  { 4, 0x88, 0x88, 0x8A, 0x41 },
  { 4, 0x88, 0x8A, 0xD9, 0x00 },
  { 4, 0x88, 0x8C, 0x0D, 0x5A },
  { 4, 0x88, 0x8E, 0x06, 0x64 },
  { 4, 0x88, 0x90, 0x8B, 0x61 },
  { 4, 0x88, 0x92, 0xE8, 0x0B },
  { 4, 0x88, 0x94, 0x00, 0x0D },
  { 4, 0x88, 0x96, 0x00, 0x20 },
  { 4, 0x88, 0x98, 0xD5, 0x08 },
  { 4, 0x88, 0x9A, 0x15, 0x04 },
  { 4, 0x88, 0x9C, 0x14, 0x00 },
  { 4, 0x88, 0x9E, 0x78, 0x40 },
  { 4, 0x88, 0xA0, 0xD0, 0x07 },
  { 4, 0x88, 0xA2, 0x0D, 0xFB },
  { 4, 0x88, 0xA4, 0x90, 0x04 },
  { 4, 0x88, 0xA6, 0xC4, 0xC1 },
  { 4, 0x88, 0xA8, 0x20, 0x29 },
  { 4, 0x88, 0xAA, 0x03, 0x00 },
  { 4, 0x88, 0xAC, 0x02, 0x19 },
  { 4, 0x88, 0xAE, 0x06, 0xC4 },
  { 4, 0x88, 0xB0, 0xFF, 0x80 },
  { 4, 0x88, 0xB2, 0x08, 0xC4 },
  { 4, 0x88, 0xB4, 0xFF, 0x80 },
  { 4, 0x88, 0xB6, 0x08, 0x6C },
  { 4, 0x88, 0xB8, 0xFF, 0x80 },
  { 4, 0x88, 0xBA, 0x08, 0xC0 },
  { 4, 0x88, 0xBC, 0xFF, 0x80 },
  { 4, 0x88, 0xBE, 0x08, 0xC4 },
  { 4, 0x88, 0xC0, 0xFF, 0x80 },
  { 4, 0x88, 0xC2, 0x09, 0x7C },
  { 4, 0x88, 0xC4, 0x00, 0x01 },
  { 4, 0x88, 0xC6, 0x00, 0x05 },
  { 4, 0x88, 0xC8, 0x00, 0x00 },
  { 4, 0x88, 0xCA, 0x00, 0x00 },
  { 4, 0x88, 0xCC, 0xC0, 0xF1 },
  { 4, 0x88, 0xCE, 0x09, 0x76 },
  { 4, 0x88, 0xD0, 0x06, 0xC4 },
  { 4, 0x88, 0xD2, 0xD6, 0x39 },
  { 4, 0x88, 0xD4, 0x77, 0x08 },
  { 4, 0x88, 0xD6, 0x8E, 0x01 },
  { 4, 0x88, 0xD8, 0x16, 0x04 },
  { 4, 0x88, 0xDA, 0x10, 0x91 },
  { 4, 0x88, 0xDC, 0x20, 0x46 },
  { 4, 0x88, 0xDE, 0x00, 0xC1 },
  { 4, 0x88, 0xE0, 0x20, 0x2F },
  { 4, 0x88, 0xE2, 0x20, 0x47 },
  { 4, 0x88, 0xE4, 0xAE, 0x21 },
  { 4, 0x88, 0xE6, 0x0F, 0x8F },
  { 4, 0x88, 0xE8, 0x14, 0x40 },
  { 4, 0x88, 0xEA, 0x8E, 0xAA },
  { 4, 0x88, 0xEC, 0x8E, 0x0B },
  { 4, 0x88, 0xEE, 0x22, 0x4A },
  { 4, 0x88, 0xF0, 0x20, 0x40 },
  { 4, 0x88, 0xF2, 0x8E, 0x2D },
  { 4, 0x88, 0xF4, 0xBD, 0x08 },
  { 4, 0x88, 0xF6, 0x7D, 0x05 },
  { 4, 0x88, 0xF8, 0x8E, 0x0C },
  { 4, 0x88, 0xFA, 0xB8, 0x08 },
  { 4, 0x88, 0xFC, 0x78, 0x25 },
  { 4, 0x88, 0xFE, 0x75, 0x10 },
  { 4, 0x89, 0x00, 0x22, 0xC2 },
  { 4, 0x89, 0x02, 0x24, 0x8C },
  { 4, 0x89, 0x04, 0x08, 0x1D },
  { 4, 0x89, 0x06, 0x03, 0x63 },
  { 4, 0x89, 0x08, 0xD9, 0xFF },
  { 4, 0x89, 0x0A, 0x25, 0x02 },
  { 4, 0x89, 0x0C, 0x10, 0x02 },
  { 4, 0x89, 0x0E, 0x2A, 0x05 },
  { 4, 0x89, 0x10, 0x03, 0xFE },
  { 4, 0x89, 0x12, 0x0A, 0x16 },
  { 4, 0x89, 0x14, 0x06, 0xE4 },
  { 4, 0x89, 0x16, 0x70, 0x2F },
  { 4, 0x89, 0x18, 0x78, 0x10 },
  { 4, 0x89, 0x1A, 0x7D, 0x02 },
  { 4, 0x89, 0x1C, 0x7D, 0xB0 },
  { 4, 0x89, 0x1E, 0xF0, 0x0B },
  { 4, 0x89, 0x20, 0x78, 0xA2 },
  { 4, 0x89, 0x22, 0x28, 0x05 },
  { 4, 0x89, 0x24, 0x03, 0xFE },
  { 4, 0x89, 0x26, 0x0A, 0x02 },
  { 4, 0x89, 0x28, 0x06, 0xE4 },
  { 4, 0x89, 0x2A, 0x70, 0x2F },
  { 4, 0x89, 0x2C, 0x78, 0x10 },
  { 4, 0x89, 0x2E, 0x65, 0x1D },
  { 4, 0x89, 0x30, 0x7D, 0xB0 },
  { 4, 0x89, 0x32, 0x7D, 0xAF },
  { 4, 0x89, 0x34, 0x8E, 0x08 },
  { 4, 0x89, 0x36, 0xBD, 0x06 },
  { 4, 0x89, 0x38, 0xD1, 0x20 },
  { 4, 0x89, 0x3A, 0xB8, 0xC3 },
  { 4, 0x89, 0x3C, 0x78, 0xA5 },
  { 4, 0x89, 0x3E, 0xB8, 0x8F },
  { 4, 0x89, 0x40, 0x19, 0x08 },
  { 4, 0x89, 0x42, 0x00, 0x24 },
  { 4, 0x89, 0x44, 0x28, 0x41 },
  { 4, 0x89, 0x46, 0x02, 0x01 },
  { 4, 0x89, 0x48, 0x1E, 0x26 },
  { 4, 0x89, 0x4A, 0x10, 0x42 },
  { 4, 0x89, 0x4C, 0x0F, 0x15 },
  { 4, 0x89, 0x4E, 0x14, 0x63 },
  { 4, 0x89, 0x50, 0x1E, 0x27 },
  { 4, 0x89, 0x52, 0x10, 0x02 },
  { 4, 0x89, 0x54, 0x22, 0x4C },
  { 4, 0x89, 0x56, 0xA0, 0x00 },
  { 4, 0x89, 0x58, 0x22, 0x4A },
  { 4, 0x89, 0x5A, 0x20, 0x40 },
  { 4, 0x89, 0x5C, 0x22, 0xC2 },
  { 4, 0x89, 0x5E, 0x24, 0x82 },
  { 4, 0x89, 0x60, 0x20, 0x4F },
  { 4, 0x89, 0x62, 0x20, 0x40 },
  { 4, 0x89, 0x64, 0x22, 0x4C },
  { 4, 0x89, 0x66, 0xA0, 0x00 },
  { 4, 0x89, 0x68, 0xB8, 0xA2 },
  { 4, 0x89, 0x6A, 0xF2, 0x04 },
  { 4, 0x89, 0x6C, 0x20, 0x45 },
  { 4, 0x89, 0x6E, 0x21, 0x80 },
  { 4, 0x89, 0x70, 0xAE, 0x01 },
  { 4, 0x89, 0x72, 0x0D, 0x9E },
  { 4, 0x89, 0x74, 0xFF, 0xE3 },
  { 4, 0x89, 0x76, 0x70, 0xE9 },
  { 4, 0x89, 0x78, 0x01, 0x25 },
  { 4, 0x89, 0x7A, 0x06, 0xC4 },
  { 4, 0x89, 0x7C, 0xC0, 0xF1 },
  { 4, 0x89, 0x7E, 0xD0, 0x10 },
  { 4, 0x89, 0x80, 0xD1, 0x10 },
  { 4, 0x89, 0x82, 0xD2, 0x0D },
  { 4, 0x89, 0x84, 0xA0, 0x20 },
  { 4, 0x89, 0x86, 0x8A, 0x00 },
  { 4, 0x89, 0x88, 0x08, 0x09 },
  { 4, 0x89, 0x8A, 0x01, 0xDE },
  { 4, 0x89, 0x8C, 0xB8, 0xA7 },
  { 4, 0x89, 0x8E, 0xAA, 0x00 },
  { 4, 0x89, 0x90, 0xDB, 0xFF },
  { 4, 0x89, 0x92, 0x2B, 0x41 },
  { 4, 0x89, 0x94, 0x02, 0x00 },
  { 4, 0x89, 0x96, 0xAA, 0x0C },
  { 4, 0x89, 0x98, 0x12, 0x28 },
  { 4, 0x89, 0x9A, 0x00, 0x80 },
  { 4, 0x89, 0x9C, 0xAA, 0x6D },
  { 4, 0x89, 0x9E, 0x08, 0x15 },
  { 4, 0x89, 0xA0, 0x01, 0xDE },
  { 4, 0x89, 0xA2, 0xB8, 0xA7 },
  { 4, 0x89, 0xA4, 0x1A, 0x28 },
  { 4, 0x89, 0xA6, 0x00, 0x02 },
  { 4, 0x89, 0xA8, 0x81, 0x23 },
  { 4, 0x89, 0xAA, 0x79, 0x60 },
  { 4, 0x89, 0xAC, 0x12, 0x28 },
  { 4, 0x89, 0xAE, 0x00, 0x80 },
  { 4, 0x89, 0xB0, 0xC0, 0xD1 },
  { 4, 0x89, 0xB2, 0x7E, 0xE0 },
  { 4, 0x89, 0xB4, 0xFF, 0x80 },
  { 4, 0x89, 0xB6, 0x01, 0x58 },
  { 4, 0x89, 0xB8, 0xFF, 0x00 },
  { 4, 0x89, 0xBA, 0x06, 0x18 },
  { 4, 0x89, 0xBC, 0x80, 0x00 },
  { 4, 0x89, 0xBE, 0x00, 0x08 },
  { 4, 0x89, 0xC0, 0xFF, 0x80 },
  { 4, 0x89, 0xC2, 0x0A, 0x08 },
  { 4, 0x89, 0xC4, 0xE2, 0x80 },
  { 4, 0x89, 0xC6, 0x24, 0xCA },
  { 4, 0x89, 0xC8, 0x70, 0x82 },
  { 4, 0x89, 0xCA, 0x78, 0xE0 },
  { 4, 0x89, 0xCC, 0x20, 0xE8 },
  { 4, 0x89, 0xCE, 0x01, 0xA2 },
  { 4, 0x89, 0xD0, 0x10, 0x02 },
  { 4, 0x89, 0xD2, 0x0D, 0x02 },
  { 4, 0x89, 0xD4, 0x19, 0x02 },
  { 4, 0x89, 0xD6, 0x00, 0x94 },
  { 4, 0x89, 0xD8, 0x7F, 0xE0 },
  { 4, 0x89, 0xDA, 0x70, 0x28 },
  { 4, 0x89, 0xDC, 0x73, 0x08 },
  { 4, 0x89, 0xDE, 0x10, 0x00 },
  { 4, 0x89, 0xE0, 0x09, 0x00 },
  { 4, 0x89, 0xE2, 0x79, 0x04 },
  { 4, 0x89, 0xE4, 0x79, 0x47 },
  { 4, 0x89, 0xE6, 0x1B, 0x00 },
  { 4, 0x89, 0xE8, 0x00, 0x64 },
  { 4, 0x89, 0xEA, 0x7E, 0xE0 },
  { 4, 0x89, 0xEC, 0xE2, 0x80 },
  { 4, 0x89, 0xEE, 0x24, 0xCA },
  { 4, 0x89, 0xF0, 0x70, 0x82 },
  { 4, 0x89, 0xF2, 0x78, 0xE0 },
  { 4, 0x89, 0xF4, 0x20, 0xE8 },
  { 4, 0x89, 0xF6, 0x01, 0xA2 },
  { 4, 0x89, 0xF8, 0x11, 0x02 },
  { 4, 0x89, 0xFA, 0x05, 0x02 },
  { 4, 0x89, 0xFC, 0x18, 0x02 },
  { 4, 0x89, 0xFE, 0x00, 0xB4 },
  { 4, 0x8A, 0x00, 0x7F, 0xE0 },
  { 4, 0x8A, 0x02, 0x70, 0x28 },
  { 4, 0x8A, 0x04, 0x00, 0x00 },
  { 4, 0x8A, 0x06, 0x00, 0x00 },
  { 4, 0x8A, 0x08, 0xFF, 0x80 },
  { 4, 0x8A, 0x0A, 0x09, 0x7C },
  { 4, 0x8A, 0x0C, 0xFF, 0x80 },
  { 4, 0x8A, 0x0E, 0x08, 0xCC },
  { 4, 0x8A, 0x10, 0x00, 0x00 },
  { 4, 0x8A, 0x12, 0x08, 0xDC },
  { 4, 0x8A, 0x14, 0x00, 0x00 },
  { 4, 0x8A, 0x16, 0x09, 0x98 },
  { 4, 0x09, 0x8E, 0x00, 0x16 }, 	// LOGICAL_ADDRESS_ACCESS [MON_ADDRESS_LO]
  { 4, 0x80, 0x16, 0x08, 0x6C }, 	// hard coded start address of the patch at "patchSetup"
  { 4, 0x80, 0x02, 0x00, 0x01 }, 	// execute the patch
};

static const UCHAR I2CDataInitPart5[][5] =
{
  { 4, 0x09, 0x8E, 0xC4, 0x0C }, 	// LOGICAL_ADDRESS_ACCESS
  { 4, 0xC4, 0x0C, 0x00, 0xFF }, 	// AFM_POS_MAX
  { 4, 0xC4, 0x0A, 0x00, 0x00 }, 	// AFM_POS_MIN
//[Lens shading correction added by Truly 121025]

//[Char settings]
//char_settings        //tuning_reg_settings_array
  { 4, 0x30, 0xD4, 0x90, 0x80 },  //COLUMN_CORRECTION
  { 4, 0x31, 0x6E, 0xC4, 0x00 }, //DAC_ECL
  { 4, 0x30, 0x5E, 0x10, 0xA0 }, //GLOBAL_GAIN
  { 4, 0x3E, 0x00, 0x00, 0x10 }, //SAMP_CONTROL
  { 4, 0x3E, 0x02, 0xED, 0x02 }, //SAMP_ADDR_EN
  { 4, 0x3E, 0x04, 0xC8, 0x8C }, //SAMP_RD1_SIG
  { 4, 0x3E, 0x06, 0xC8, 0x8C }, //SAMP_RD1_SIG_BOOST
  { 4, 0x3E, 0x08, 0x70, 0x0A }, //SAMP_RD1_RST
  { 4, 0x3E, 0x0A, 0x70, 0x1E }, //SAMP_RD1_RST_BOOST
  { 4, 0x3E, 0x0C, 0x00, 0xFF }, //SAMP_RST1_EN
  { 4, 0x3E, 0x0E, 0x00, 0xFF }, //SAMP_RST1_BOOST
  { 4, 0x3E, 0x10, 0x00, 0xFF }, //SAMP_RST1_CLOOP_SH
  { 4, 0x3E, 0x12, 0x00, 0x00 }, //SAMP_RST_BOOST_SEQ
  { 4, 0x3E, 0x14, 0xC7, 0x8C }, //SAMP_SAMP1_SIG
  { 4, 0x3E, 0x16, 0x6E, 0x06 }, //SAMP_SAMP1_RST
  { 4, 0x3E, 0x18, 0xA5, 0x8C }, //SAMP_TX_EN
  { 4, 0x3E, 0x1A, 0xA5, 0x8E }, //SAMP_TX_BOOST
  { 4, 0x3E, 0x1C, 0xA5, 0x8E }, //SAMP_TX_CLOOP_SH
  { 4, 0x3E, 0x1E, 0xC0, 0xD0 }, //SAMP_TX_BOOST_SEQ
  { 4, 0x3E, 0x20, 0xEB, 0x00 }, //SAMP_VLN_EN
  { 4, 0x3E, 0x22, 0x00, 0xFF }, //SAMP_VLN_HOLD
  { 4, 0x3E, 0x24, 0xEB, 0x02 }, //SAMP_VCL_EN
  { 4, 0x3E, 0x26, 0xEA, 0x02 }, //SAMP_COLCLAMP
  { 4, 0x3E, 0x28, 0xEB, 0x0A }, //SAMP_SH_VCL
  { 4, 0x3E, 0x2A, 0xEC, 0x01 }, //SAMP_SH_VREF
  { 4, 0x3E, 0x2C, 0xEB, 0x01 }, //SAMP_SH_VBST
  { 4, 0x3E, 0x2E, 0x00, 0xFF }, //SAMP_SPARE
  { 4, 0x3E, 0x30, 0x00, 0xF3 }, //SAMP_READOUT
  { 4, 0x3E, 0x32, 0x3D, 0xFA }, //SAMP_RESET_DONE
  { 4, 0x3E, 0x34, 0x00, 0xFF }, //SAMP_VLN_CLAMP
  { 4, 0x3E, 0x36, 0x00, 0xF3 }, //SAMP_ASC_INT
  { 4, 0x3E, 0x38, 0x00, 0x00 }, //SAMP_RS_CLOOP_SH_R
  { 4, 0x3E, 0x3A, 0xF8, 0x02 }, //SAMP_RS_CLOOP_SH
  { 4, 0x3E, 0x3C, 0x0F, 0xFF }, //SAMP_RS_BOOST_SEQ
  { 4, 0x3E, 0x3E, 0xEA, 0x10 }, //SAMP_TXLO_GND
  { 4, 0x3E, 0x40, 0xEB, 0x05 }, //SAMP_VLN_PER_COL
  { 4, 0x3E, 0x42, 0xE5, 0xC8 }, //SAMP_RD2_SIG
  { 4, 0x3E, 0x44, 0xE5, 0xC8 }, //SAMP_RD2_SIG_BOOST
  { 4, 0x3E, 0x46, 0x8C, 0x70 }, //SAMP_RD2_RST
  { 4, 0x3E, 0x48, 0x8C, 0x71 }, //SAMP_RD2_RST_BOOST
  { 4, 0x3E, 0x4A, 0x00, 0xFF }, //SAMP_RST2_EN
  { 4, 0x3E, 0x4C, 0x00, 0xFF }, //SAMP_RST2_BOOST
  { 4, 0x3E, 0x4E, 0x00, 0xFF }, //SAMP_RST2_CLOOP_SH
  { 4, 0x3E, 0x50, 0xE3, 0x8D }, //SAMP_SAMP2_SIG
  { 4, 0x3E, 0x52, 0x8B, 0x0A }, //SAMP_SAMP2_RST
  { 4, 0x3E, 0x58, 0xEB, 0x0A }, //SAMP_PIX_CLAMP_EN
  { 4, 0x3E, 0x5C, 0x0A, 0x00 }, //SAMP_PIX_PULLUP_EN
  { 4, 0x3E, 0x5E, 0x00, 0xFF }, //SAMP_PIX_PULLDOWN_EN_R
  { 4, 0x3E, 0x60, 0x00, 0xFF }, //SAMP_PIX_PULLDOWN_EN_S
  { 4, 0x3E, 0x90, 0x3C, 0x01 }, //RST_ADDR_EN
  { 4, 0x3E, 0x92, 0x00, 0xFF }, //RST_RST_EN
  { 4, 0x3E, 0x94, 0x00, 0xFF }, //RST_RST_BOOST
  { 4, 0x3E, 0x96, 0x3C, 0x00 }, //RST_TX_EN
  { 4, 0x3E, 0x98, 0x3C, 0x00 }, //RST_TX_BOOST
  { 4, 0x3E, 0x9A, 0x3C, 0x00 }, //RST_TX_CLOOP_SH
  { 4, 0x3E, 0x9C, 0xC0, 0xE0 }, //RST_TX_BOOST_SEQ
  { 4, 0x3E, 0x9E, 0x00, 0xFF }, //RST_RST_CLOOP_SH
  { 4, 0x3E, 0xA0, 0x00, 0x00 }, //RST_RST_BOOST_SEQ
  { 4, 0x3E, 0xA6, 0x3C, 0x00 }, //RST_PIX_PULLUP_EN
  { 4, 0x3E, 0xD8, 0x30, 0x57 }, //DAC_LD_12_13
  { 4, 0x31, 0x6C, 0xB4, 0x4F }, //DAC_TXLO
  { 4, 0x31, 0x6E, 0xC6, 0xFF }, //DAC_ECL
  { 4, 0x3E, 0xD2, 0xEA, 0x0A }, //DAC_LD_6_7
  { 4, 0x3E, 0xD4, 0x00, 0xA3 }, //DAC_LD_8_9
  { 4, 0x3E, 0xDC, 0x60, 0x20 }, //DAC_LD_16_17
  { 4, 0x3E, 0xE6, 0xA5, 0x41 }, //DAC_LD_26_27
  { 4, 0x31, 0xE0, 0x00, 0x00 }, //PIX_DEF_ID
  { 4, 0x3E, 0xD0, 0x24, 0x09 }, //DAC_LD_4_5
  { 4, 0x3E, 0xDE, 0x0A, 0x49 }, //DAC_LD_18_19
  { 4, 0x3E, 0xE0, 0x49, 0x10 },//0x4909  //DAC_LD_20_21
  { 4, 0x3E, 0xE2, 0x09, 0xD2 },//0x09CF  //DAC_LD_22_23
  { 4, 0x30, 0xB6, 0x00, 0x08 }, //AUTOLR_CONTROL
  { 4, 0x33, 0x7C, 0x00, 0x06 }, //YUV_YCBCR_CONTROL
  { 4, 0x3E, 0x1A, 0xA5, 0x82 }, //SAMP_TX_BOOST
  { 4, 0x3E, 0x2E, 0xEC, 0x05 }, //SAMP_SPARE
  { 4, 0x3E, 0xE6, 0xA5, 0xC0 }, //DAC_LD_26_27
  { 4, 0x31, 0x6C, 0xB4, 0x3F },//0xF43F   //B43F, //DAC_TXLO
  { 4, 0x31, 0x6E, 0xC6, 0xFF }, //DAC_ECL
//[Step5-AWB_CCM]
//AWB_setup
  { 4, 0x09, 0x8E, 0xAC, 0x01 }, // LOGICAL_ADDRESS_ACCESS [AWB_MODE]
//[tint control and saturation]
  { 3, 0xAC, 0x01, 0xFF },  // AWB_MODE
  { 4, 0xAC, 0x02, 0x00, 0x7F },   // AWB_ALGO
  { 3, 0xAC, 0x96, 0x01 },   // AWB_CCM_TINTING_TH
  { 3, 0xAC, 0x97, 0x68 },   // AWB_LEFT_TINT_COEF_FOR_CCM_ROW_0
  { 3, 0xAC, 0x98, 0x80 },   // AWB_LEFT_TINT_COEF_FOR_CCM_ROW_1
  { 3, 0xAC, 0x99, 0x8F },   // AWB_LEFT_TINT_COEF_FOR_CCM_ROW_2
  { 3, 0xAC, 0x9A, 0x74 },   // AWB_RIGHT_TINT_COEF_FOR_CCM_ROW_0
  { 3, 0xAC, 0x9B, 0x80 },   // AWB_RIGHT_TINT_COEF_FOR_CCM_ROW_1
  { 3, 0xAC, 0x9C, 0x82 },   // AWB_RIGHT_TINT_COEF_FOR_CCM_ROW_2
  { 3, 0xAC, 0x9D, 0x80 },   // AWB_PCR_SATURATION
  { 3, 0xBC, 0x56, 0xae },   //0x95  // LL_START_CCM_SATURATION
  { 3, 0xBC, 0x57, 0x00 },   // LL_END_CCM_SATURATION
//[Pre AWB ratio]
  { 3, 0xAC, 0xB0, 0x32 },   // AWB_RG_MIN
  { 3, 0xAC, 0xB1, 0x4E },   // AWB_RG_MAX
  { 3, 0xAC, 0xB4, 0x26 },   // AWB_BG_MIN
  { 3, 0xAC, 0xB5, 0x4F },   // AWB_BG_MAX
  { 3, 0xAC, 0x3C, 0x32 },   // AWB_MIN_ACCEPTED_PRE_AWB_R2G_RATIO
  { 3, 0xAC, 0x3D, 0x4E },   // AWB_MAX_ACCEPTED_PRE_AWB_R2G_RATIO
  { 3, 0xAC, 0x3E, 0x26 },   // AWB_MIN_ACCEPTED_PRE_AWB_B2G_RATIO
  { 3, 0xAC, 0x3F, 0x4F },   // AWB_MAX_ACCEPTED_PRE_AWB_B2G_RATIO
//[Weight table and checker offset]
  { 4, 0x32, 0x42, 0x00, 0x00 },   // AWB_WEIGHT_R0
  { 4, 0x32, 0x44, 0x00, 0x00 },   // AWB_WEIGHT_R1
  { 4, 0x32, 0x46, 0x00, 0x00 },   // AWB_WEIGHT_R2
  { 4, 0x32, 0x48, 0x3F, 0x00 },   // AWB_WEIGHT_R3
  { 4, 0x32, 0x4A, 0xA5, 0x00 },   // AWB_WEIGHT_R4
  { 4, 0x32, 0x4C, 0x15, 0x40 },   // AWB_WEIGHT_R5
  { 4, 0x32, 0x4E, 0x01, 0xEC },   // AWB_WEIGHT_R6
  { 4, 0x32, 0x50, 0x00, 0x7E },   // AWB_WEIGHT_R7
  { 4, 0x32, 0x3C, 0x00, 0x08 },   // AWB_X_SHIFT
  { 4, 0x32, 0x3E, 0x00, 0x1F },   // AWB_Y_SHIFT
  { 4, 0xB8, 0x42, 0x00, 0x3A },   // STAT_AWB_GRAY_CHECKER_OFFSET_X
  { 4, 0xB8, 0x44, 0x00, 0x43 },   // STAT_AWB_GRAY_CHECKER_OFFSET_Y
//[CCM]
  { 4, 0xAC, 0x46, 0x01, 0xCB },   // AWB_LEFT_CCM_0
  { 4, 0xAC, 0x48, 0xFE, 0xF7 },   // AWB_LEFT_CCM_1
  { 4, 0xAC, 0x4A, 0x00, 0x3F },   // AWB_LEFT_CCM_2
  { 4, 0xAC, 0x4C, 0xFF, 0xB2 },   // AWB_LEFT_CCM_3
  { 4, 0xAC, 0x4E, 0x01, 0x18 },   // AWB_LEFT_CCM_4
  { 4, 0xAC, 0x50, 0x00, 0x36 },   // AWB_LEFT_CCM_5
  { 4, 0xAC, 0x52, 0xFF, 0xE5 },   // AWB_LEFT_CCM_6
  { 4, 0xAC, 0x54, 0xFE, 0xF3 },   // AWB_LEFT_CCM_7
  { 4, 0xAC, 0x56, 0x02, 0x27 },   // AWB_LEFT_CCM_8
  { 4, 0xAC, 0x58, 0x00, 0xB0 },   // AWB_LEFT_CCM_R2BRATIO
  { 4, 0xAC, 0x5C, 0x02, 0x54 },   // AWB_RIGHT_CCM_0
  { 4, 0xAC, 0x5E, 0xFE, 0xD1 },   // AWB_RIGHT_CCM_1
  { 4, 0xAC, 0x60, 0xFF, 0xDB },   // AWB_RIGHT_CCM_2
  { 4, 0xAC, 0x62, 0xFF, 0xC6 },   // AWB_RIGHT_CCM_3
  { 4, 0xAC, 0x64, 0x01, 0x47 },   // AWB_RIGHT_CCM_4
  { 4, 0xAC, 0x66, 0xFF, 0xF2 },   // AWB_RIGHT_CCM_5
  { 4, 0xAC, 0x68, 0x00, 0x08 },   // AWB_RIGHT_CCM_6
  { 4, 0xAC, 0x6A, 0xFF, 0x6A },   // AWB_RIGHT_CCM_7
  { 4, 0xAC, 0x6C, 0x01, 0x8E },   // AWB_RIGHT_CCM_8
  { 4, 0xAC, 0x6E, 0x00, 0x76 },   // AWB_RIGHT_CCM_R2BRATIO
  { 3, 0xB8, 0x3E, 0x00 },   // STAT_AWB_WINDOW_POS_X
  { 3, 0xB8, 0x3F, 0x00 },   // STAT_AWB_WINDOW_POS_Y
  { 3, 0xB8, 0x40, 0xFF },   // STAT_AWB_WINDOW_SIZE_X
  { 3, 0xB8, 0x41, 0xEF },   // STAT_AWB_WINDOW_SIZE_Y
  { 3, 0x84, 0x04, 0x05 },   // SEQ_CMD
//[color kill]
  { 3, 0xDC, 0x36, 0x43 },       // SYS_DARK_COLOR_KILL
  { 4, 0xDC, 0x02, 0x30, 0x3E },   // SYS_ALGO
  { 4, 0x35, 0xA2, 0x00, 0xA3 },   // DARK_COLOR_KILL_CONTROLS
};
static const UCHAR I2CDataInitPart6[][5] =
{
  { 4, 0x09, 0x8E, 0x84, 0x04 },	// Refresh Sequencer Mode
  { 3, 0x09, 0x90, 0x01 },	        //      = 1 => goto context A
};
static const UCHAR I2CDataInitPart7[][5] =
{
//[AE RULE]
  { 4, 0x09, 0x8E, 0xA4, 0x09 },   // LOGICAL_ADDRESS_ACCESS [AE_RULE_BASE_TARGET]
  { 3, 0xA4, 0x09, 0x4f },         // AE_RULE_BASE_TARGET
//[Frame min 5 fps]  
  { 4, 0x09, 0x8E, 0x28, 0x1A },   // LOGICAL_ADDRESS_ACCESS [AE_TRACK_MAX_INT_TIME_ROWS]
  { 4, 0xA8, 0x1A, 0x19, 0xD2 },   // AE_TRACK_MAX_INT_TIME_ROWS
  { 4, 0x84, 0x04, 0x05 },
};

static const UCHAR I2CDataInitPart7GF[][5] =
{
//[AE RULE]
  { 4, 0x09, 0x8E, 0xA4, 0x09 },   // LOGICAL_ADDRESS_ACCESS [AE_RULE_BASE_TARGET]
  { 3, 0xA4, 0x09, 0x4f },         // AE_RULE_BASE_TARGET
//[Frame min 5 fps]  
  { 4, 0x09, 0x8E, 0x28, 0x1A },   // LOGICAL_ADDRESS_ACCESS [AE_TRACK_MAX_INT_TIME_ROWS]
  { 4, 0xA8, 0x1A, 0x19, 0xD2 },   // AE_TRACK_MAX_INT_TIME_ROWS
  { 4, 0x84, 0x04, 0x05 },
};
static const UCHAR I2CDataInitPart8[][5] =
{
    { 4, 0x33, 0x7C, 0x00, 0x0E },
    { 4, 0x3C, 0x42, 0x00, 0x01 },
};

static const UCHAR I2CDataInitPart9[][5] =
{
    { 4, 0x09, 0x8E, 0x84, 0x3C }, 
    { 3, 0x09, 0x90, 0x04 }, 
    { 4, 0x09, 0x8E, 0x84, 0x04 }, 
    { 3, 0x09, 0x90, 0x02 }, 
};

static const UCHAR I2CDataInitPart10[][5] =
{
    { 4, 0x3C, 0x00, 0x00, 0x07 },  // jpssmode, Jpeg with embedded thumbnail [JALE]
	{ 4, 0x3c, 0x02, 0x06, 0x11},	//-- jpssmode_ctrl, jpss_enable_status_markers, jpss_insert_jpeg_status [JALE]
    { 4, 0xD8, 0x16, 0x02, 0x80 }, // jpeg_thumbnail_width = 640 [JALE]
    { 4, 0xD8, 0x18, 0x01, 0xE0 }, // jpeg_thumbnail_height = 480 [JALE]
    { 4, 0xD8, 0x26, 0x02, 0x11 }, // jpeg_tn_ctrl_var, YCbCr thumbnail [JALE]
	{ 4, 0x3C, 0x80, 0x02, 0x11},	//-- tn_yuv [JALE]
};

static const UCHAR I2CDataStandByEnter[][5] = {
	{ 4, 0x00, 0x28, 0x00, 0x00 },  // (en_vdd_dis_soft bit) = 0.
    { 4, 0x00, 0x18, 0x20, 0x09 }, 
};

static const UCHAR I2CDataStandByExit[][5] = {
    { 4, 0x00, 0x18, 0x20, 0x08 }, 
	{ 4, 0x00, 0x28, 0x00, 0x01 },	//(en_vdd_dis_soft bit) = 1.

};

static const UCHAR I2CDataGrab[][5] =
{
    { 4, 0x09, 0x8E, 0x84, 0x3C },  // seq_state_cfg_5_max_frame_cnt
    { 3, 0x09, 0x90, 0x03 },  
    { 4, 0x09, 0x8E, 0x84, 0x04 },	 // Refresh Sequencer Mode
    { 4, 0x09, 0x90, 0x02 },		//      = 1 => goto context B
};
// Local functions

static unsigned long GetTickCount(void)
{
    struct timeval tv;

    do_gettimeofday(&tv);

    return tv.tv_sec * 1000 + tv.tv_usec/1000;
}

static BOOL DoI2CWrite (PCAM_HW_INDEP_INFO pInfo,
						const UCHAR *buf,
						USHORT elements,
						UCHAR pollReg,
						USHORT pollValue,
						USHORT timeout,
						CAM_NO camera)
{
	struct i2c_msg msgs[2];
    DWORD ret;
    int i;
    int retries = 50;
    DWORD cam;
    const UCHAR *ptr;
    BOOL ready;
    DWORD start;
    UCHAR cmd[2];
    UCHAR stat[2];
    USHORT status = 0;
    DWORD cam_first = (camera == CAM_2) ? CAM_2 : CAM_1;
    DWORD cam_last = (camera == CAM_1) ? CAM_1 : CAM_2;

    for (cam=cam_first; cam<=cam_last; cam++)
    {
        // Check if camera in use
        msgs[0].addr = pInfo->cameraI2CAddress[cam] >> 1;
        if (msgs[0].addr == 0)
            continue;
        msgs[1].addr = msgs[0].addr;

        if (pollReg)
        {
            // Poll camera to be ready for transfer
            ready = FALSE;
            start = GetTickCount();
            while (!ready)
            {
                msleep(10);

                msgs[0].flags = 0;
                msgs[0].len = 2;
                msgs[0].buf = cmd;
                msgs[1].flags = I2C_M_RD | I2C_M_NOSTART;
                msgs[1].len = 2;
                msgs[1].buf = stat;

                cmd[0] = 0;
                cmd[1] = pollReg;
                ret = i2c_transfer(pInfo->hI2C, msgs, 2);
                        
                if (ret > 0)
                {
                    status = (stat[0] << 8) | stat[1];
                    if (status == pollValue)
                    {
                    	pr_err("DoI2CWrite cam %lu got result %X in %lu ms\n", cam, status, GetTickCount() - start);
                        ready = TRUE;
                    }
                }
                if ((GetTickCount() - start) > timeout)
                {
                    break;
                }
            }
            if (!ready)
            {
                pr_err("DoI2CWrite cam %lu timeout with result %X\n", cam, status);
            }
        }
        else if (cam == cam_first)
        {
            // Fixed delay
            msleep(timeout);
        }

        ptr = buf;
        msgs[0].flags = 0;

        for (i=0; i<elements; i++)
        {
            msgs[0].len = ptr[0];
            msgs[0].buf = (UCHAR *)(ptr+1);
            ret = i2c_transfer(pInfo->hI2C, msgs, 1);

            if (ret <= 0)
            {
                if (retries-- <= 0)
                {
                    pr_err("DoI2CWrite failing on element %d of %d\n", i, elements);
                    return FALSE;       // Too many errors, give up
                }
                msleep (10);
                i--;
                continue;
            }
            ptr+=5;
        }
    }

    return TRUE;
}
#if 0
static BOOL DoI2CRead (PCAM_HW_INDEP_INFO pInfo, USHORT *result, USHORT reg, CAM_NO camera)
{
	struct i2c_msg msgs[2];
    DWORD ret = 0;
    UCHAR cmd[2];
    UCHAR stat[2];

    // Check if camera in use
    msgs[0].addr = BSPGetCameraI2CAddress(camera) >> 1;
    if (msgs[0].addr == 0)
        return TRUE;
    msgs[1].addr = msgs[0].addr;

    msgs[0].flags = 0;
    msgs[0].len = 2;
    msgs[0].buf = cmd;
    msgs[1].flags = I2C_M_RD | I2C_M_NOSTART;
    msgs[1].len = 2;
    msgs[1].buf = stat;

    cmd[0] = (UCHAR)(reg >> 8);
    cmd[1] = (UCHAR)(reg & 0xFF);

    ret = i2c_transfer(pInfo->hI2C, msgs, 2);

    if (ret > 0)
    {
        *result = (stat[0] << 8) | stat[1];
    }
    else
    {
        pr_err("DoI2CRead failing reading reg %d\n", reg);
    }
    return ret;
}
#endif

static BOOL initCamera (PCAM_HW_INDEP_INFO pInfo, BOOL fullInit, CAM_NO cam)
{
	BOOL ret = TRUE;

    ret = DoI2CWrite(pInfo, I2CDataInitPart1[0], dim(I2CDataInitPart1), 0x18, 0x4009, 100, cam);
    if (ret)
        ret = DoI2CWrite(pInfo, I2CDataInitPart2[0], dim(I2CDataInitPart2), 0x18, 0x2008, 1000, cam);
    if (ret)
        ret = DoI2CWrite(pInfo, I2CDataInitPart3[0], dim(I2CDataInitPart3), 0x18, 0x4009, 1000, cam);
    if (ret)
        ret = DoI2CWrite(pInfo, I2CDataInitPart4[0], dim(I2CDataInitPart4), 0, 0, 100, cam);
    if (ret)
        ret = DoI2CWrite(pInfo, I2CDataInitPart5[0], dim(I2CDataInitPart5), 0, 0, 200, cam);
    if (ret)
        ret = DoI2CWrite(pInfo, I2CDataInitPart6[0], dim(I2CDataInitPart6), 0, 0, 200, cam);
    if (ret)
        ret = DoI2CWrite(pInfo, I2CDataInitPart8[0], dim(I2CDataInitPart8), 0, 0, 200, cam);
    if (ret)
        ret = DoI2CWrite(pInfo, I2CDataInitPart9[0], dim(I2CDataInitPart9), 0, 0, 200, cam);
    if (ret)
        ret = DoI2CWrite(pInfo, I2CDataInitPart10[0], dim(I2CDataInitPart10), 0x16, 0x0447, 1000, cam);
    if (ret)
        ret = DoI2CWrite(pInfo, I2CDataInitPart7[0], dim(I2CDataInitPart7), 0, 0, 200, cam);

	return ret;
}

BOOL MT9P111_Init(PCAM_HW_INDEP_INFO pInfo)
{
	initCamera(pInfo, TRUE, CAM_ALL);
	if (bCamActive[CAM_1] == FALSE)
		DoI2CWrite(pInfo, I2CDataStandByEnter[0], dim(I2CDataStandByEnter), 0, 0, 0, CAM_1);
	if (bCamActive[CAM_2] == FALSE)
		DoI2CWrite(pInfo, I2CDataStandByEnter[0], dim(I2CDataStandByEnter), 0, 0, 0, CAM_2);
	return TRUE;
}

DWORD MT9P111_IOControl(PCAM_HW_INDEP_INFO pInfo,
                        DWORD  Ioctl,
                        PUCHAR pBuf,
                        PUCHAR pUserBuf)
{
    DWORD  dwErr = ERROR_INVALID_PARAMETER;
    static BOOL bTestActive;

    switch (Ioctl) 
	{
        case IOCTL_CAM_GET_TEST:   
			{
	   			LOCK(pInfo);
                ((VCAMIOCTLTEST *)pBuf)->bTestMode = bTestActive;
				dwErr = ERROR_SUCCESS;
        		UNLOCK(pInfo);
   			}
            break;

		case IOCTL_CAM_SET_TEST:
            {
			    LOCK(pInfo);
				bTestActive = (((VCAMIOCTLTEST *)pBuf)->bTestMode != 0);
				dwErr = ERROR_SUCCESS;
			    UNLOCK(pInfo);
            }
            break;

		case IOCTL_CAM_GET_ACTIVE:   
            {
				VCAMIOCTLACTIVE * pVcamIoctl = (VCAMIOCTLACTIVE *)pBuf;
    			LOCK(pInfo);
				pVcamIoctl->bActive = bCamActive[CAM_1] || bCamActive[CAM_2];
				dwErr = ERROR_SUCCESS;
        		UNLOCK(pInfo);
   			}
            break;

		case IOCTL_CAM_SET_ACTIVE:
		case IOCTL_CAM_SET_2ND_ACTIVE:
            {
				BOOL bNewActive;
				BOOL res = TRUE;
				CAM_NO cam = (Ioctl == IOCTL_CAM_SET_ACTIVE) ? CAM_1 : CAM_2;
    			LOCK(pInfo);
				bNewActive = (((VCAMIOCTLACTIVE *)pBuf)->bActive != 0);
				if (bNewActive != bCamActive[cam])
				{
					if (bNewActive)
					{
						res = DoI2CWrite(pInfo, I2CDataStandByExit[0], dim(I2CDataStandByExit), 0, 0, 0, cam);

					}
					else
					{
						res = DoI2CWrite(pInfo, I2CDataStandByEnter[0], dim(I2CDataStandByEnter), 0, 0, 0, cam);
					}
				}

				if (res)
				{
					bCamActive[cam] = bNewActive;
					pr_err("bCamActive for cam %d now %d\n", cam, bCamActive[cam]);
					dwErr = ERROR_SUCCESS;
				}
        		UNLOCK(pInfo);
            }
            break;

		case IOCTL_CAM_SET_FLASH:
            {
				VCAMIOCTLFLASH * pFlashData = (VCAMIOCTLFLASH *) pBuf;
			    LOCK(pInfo);

				if (pFlashData->bFlashOn)
				{
				}

				dwErr = pInfo->pSetTorchState(pFlashData);
			    UNLOCK(pInfo);
            }
            break;

        case IOCTL_CAM_GRAB_STILL:
            {
                CAM_NO cam = (bCamActive[CAM_1] == TRUE) ? CAM_1 : CAM_2;

    			LOCK(pInfo);
                // Tell camera to switch to context B
                DoI2CWrite(pInfo, I2CDataGrab[0], dim(I2CDataGrab), 0, 0, 0, cam);

                dwErr = ERROR_SUCCESS;
    			UNLOCK(pInfo);
            }
            break;

		default:
			pr_err("VCAM Unsupported IOCTL code %lu\n", Ioctl);
			dwErr = ERROR_NOT_SUPPORTED;
			break;
    }
	
    return dwErr;
}



